services:
  redis:
    image: bitnami/redis:8.0
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/bitnami/redis/data
    environment:
      - REDIS_PASSWORD
    networks:
      - a5t

  kafka:
    image: bitnami/kafka:4.0
    environment:
      - KAFKA_CFG_KRAFT_MODE=true
      - KAFKA_CFG_CLUSTER_ID=${KAFKA_CLUSTER_ID}
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_LISTENERS=INTERNAL://:9092,CONTROLLER://:9093,DOCKER://:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=INTERNAL://localhost:9092,DOCKER://kafka:9094
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:SASL_PLAINTEXT,CONTROLLER:SASL_PLAINTEXT,DOCKER:SASL_PLAINTEXT
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=INTERNAL
      - KAFKA_CFG_SASL_ENABLED_MECHANISMS=PLAIN
      - KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL=PLAIN
      - KAFKA_CFG_SASL_MECHANISM_CONTROLLER_PROTOCOL=PLAIN
      - KAFKA_CFG_AUTHORIZER_CLASS_NAME=org.apache.kafka.metadata.authorizer.StandardAuthorizer
      - KAFKA_INTER_BROKER_USER=admin
      - KAFKA_INTER_BROKER_PASSWORD=${KAFKA_ADMIN_PASSWORD}
      - KAFKA_SUPER_USERS=User:admin
      - KAFKA_CFG_SUPER_USERS=User:admin
      - KAFKA_CONTROLLER_USER=admin
      - KAFKA_CONTROLLER_PASSWORD=${KAFKA_ADMIN_PASSWORD}
      - KAFKA_CLIENT_USERS=admin
      - KAFKA_CLIENT_PASSWORDS=${KAFKA_ADMIN_PASSWORD}
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    ports:
      - "9092:9092"
    volumes:
      - kafka_data:/bitnami/kafka
    networks:
      - a5t
  mongo:
    image: mongo:8.0
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    restart: unless-stopped
    # command: ["mongod", "--keyFile", "/data/db/mongo-keyfile", "--bind_ip_all"]
    networks:
      - a5t
  # app:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   environment:
  #     MONGO_URL: ${MONGO_URL}
  #     SECRET_KEY: ${SECRET_KEY}
  #     DATABASE_NAME: ${DATABASE_NAME}
  #     REDIS_HOST: redis
  #     REDIS_PORT: 6379
  #     REDIS_PASSWORD: ${REDIS_PASSWORD}
  #     KAFKA_BROKER: kafka:9094
  #     KAFKA_USERNAME: admin
  #     KAFKA_PASSWORD: ${KAFKA_ADMIN_PASSWORD}
  #   labels:
  #     - "traefik.enable=true"
  #     - "traefik.http.routers.mycelia.rule=Host(`mycelia.tigor.net`)"
  #     - "traefik.http.routers.mycelia.service=mycelia"
  #     - "traefik.http.services.mycelia.loadbalancer.server.port=3000"
  #   networks:
  #     - a5t
  #     # - traefik_default

networks:
  a5t:
  # traefik_default:
  #   external: true


volumes:
  kafka_data:
  mongo_data:
  redis_data: